<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat con tus Amigos</title>
  <style>
      body { font-family: Arial, sans-serif; background: #f0f0f0; }
      #chat { width: 100%; max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
      #messages { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
      #msg-input, #nickname-input { width: 40%; }
      #send-btn { width: 18%; }
      .msg { margin-bottom: 10px; }
      .username { font-weight: bold; color: #4a90e2; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>Chat con tus Amigos</h2>
    <div id="profile">
      <input id="nickname-input" type="text" placeholder="Apodo" autocomplete="off" />
      <input id="avatar-input" type="file" accept="image/*" />
      <img id="avatar-preview" src="" alt="Tu imagen" style="width:40px; height:40px; border-radius:50%; display:none;" />
    </div>
    <div id="messages"></div>
    <input id="msg-input" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" />
    <button id="send-btn">Enviar</button>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const messages = document.getElementById('messages');
    const sendBtn = document.getElementById('send-btn');
    const nicknameInput = document.getElementById('nickname-input');
    const avatarInput = document.getElementById('avatar-input');
    const avatarPreview = document.getElementById('avatar-preview');
    const msgInput = document.getElementById('msg-input');

    let avatarData = "";

    avatarInput.onchange = function() {
      const file = avatarInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          avatarData = e.target.result;
          avatarPreview.src = avatarData;
          avatarPreview.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
      }
    };

    sendBtn.onclick = function() {
      const nickname = nicknameInput.value.trim() || "AnÃ³nimo";
      const msg = msgInput.value.trim();
      if(msg.length > 0){
        socket.emit('chat message', {
          nickname: nickname,
          avatar: avatarData,
          text: msg
        });
        msgInput.value = '';
      }
    };
    msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendBtn.click(); });

    socket.on('chat message', function(data){
      const p = document.createElement('div');
      p.className = 'msg';
      let avatarTag = "";
      if(data.avatar) avatarTag = `<img src="${data.avatar}" style="width:32px; height:32px; border-radius:50%; vertical-align:middle;" /> `;
      p.innerHTML = `${avatarTag}<span class="username">${data.nickname}:</span> ${data.text}`;
      messages.appendChild(p);
      messages.scrollTop = messages.scrollHeight;
    });
  </script>
</body>
</html>
